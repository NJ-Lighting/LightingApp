<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LightingApp – Field Tools</title>
<meta name="theme-color" content="#0b0f15" />
<style>
  :root{
    --bg:#0b0f15; --panel:#101724; --panel-2:#0f1521; --muted:#9aa4b2; --text:#e7eaf0;
    --accent:#22d3ee; --accent-2:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --border:#1f2a3a; --chip:#0e2238; --shadow:0 6px 20px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    background: radial-gradient(1400px 700px at 80% -10%, #0f192a 0%, var(--bg) 45%),
                radial-gradient(900px 500px at 0% 100%, #0c1322 0%, var(--bg) 60%);
    color:var(--text);
  }
  a{color:#93c5fd}
  .app{max-width:1200px; margin:0 auto; padding:10px env(safe-area-inset-right) 24px env(safe-area-inset-left)}
  header{
    position:sticky; top:0; z-index:30; backdrop-filter:saturate(1.2) blur(8px);
    background:linear-gradient(180deg, rgba(11,15,21,.85), rgba(11,15,21,.6));
    border-bottom:1px solid var(--border);
  }
  .head-wrap{display:flex; align-items:center; gap:12px; padding:12px 8px}
  .logo{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
  .logo svg{width:28px; height:28px}
  .tabs{display:flex; gap:8px; overflow:auto; scrollbar-width:none; padding:8px 8px 12px}
  .tabs::-webkit-scrollbar{display:none}
  .tab{
    padding:10px 14px; border:1px solid var(--border); border-radius:999px; background:var(--panel);
    box-shadow:var(--shadow); white-space:nowrap; font-weight:600; opacity:.9; transition:all .2s;
  }
  .tab[aria-current="page"]{outline:2px solid var(--accent); opacity:1}
  section.card{
    background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:14px;
  }
  .card h2{margin:4px 0 12px; font-size:1.1rem; letter-spacing:.2px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .field{display:flex; flex-direction:column; gap:6px; min-width:120px; flex:1}
  label{font-size:.85rem; color:var(--muted)}
  input, select, textarea, button{font:inherit}
  input, select, textarea{
    background:#0c1320; color:var(--text); border:1px solid var(--border); border-radius:12px;
    padding:12px 12px; outline:0; min-height:42px;
  }
  input:focus, select:focus, textarea:focus{border-color:#2d90ff; box-shadow:0 0 0 3px rgba(45,144,255,.2)}
  button{
    appearance:none; border:1px solid var(--border); background:#0e1726; color:var(--text);
    padding:11px 14px; border-radius:12px; cursor:pointer; font-weight:650; transition:transform .06s,background .2s,border-color .2s;
  }
  button:hover{background:#111e33}
  button:active{transform:translateY(1px)}
  .btn-primary{background:linear-gradient(180deg,#1d5fff,#2ea3ff); border-color:#2c7be5}
  .btn-ghost{background:transparent}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{border:1px solid var(--border); background:var(--chip); border-radius:999px; padding:8px 12px; font-size:.85rem}
  .table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px}
  table{width:100%; border-collapse:collapse; min-width:760px}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
  th{color:#b8c2cf; background:#0e1626; position:sticky; top:0; z-index:1; user-select:none}
  .hint{color:var(--muted); font-size:.85rem}
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0c1422; padding:2px 6px; border-radius:6px; border:1px solid var(--border)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#0c1320}

  /* Sortable headers */
  th.sortable{cursor:pointer; position:relative; padding-right:22px}
  th.sortable::after{
    content:''; position:absolute; right:8px; top:50%; transform:translateY(-50%);
    border-left:5px solid transparent; border-right:5px solid transparent;
    border-top:6px solid #6b7280; opacity:.5;
  }
  th.sortable[aria-sort="ascending"]::after{ border-top:0; border-bottom:6px solid #e5e7eb; opacity:1 }
  th.sortable[aria-sort="descending"]::after{ border-top:6px solid #e5e7eb; opacity:1 }

  /* DIP grid */
  .toggles{display:flex; gap:10px; flex-wrap:wrap}
  .dip{display:grid; grid-template-rows: auto auto auto; gap:4px; align-items:center; justify-items:center; width:64px}
  .dip .num{font-size:.75rem; color:var(--muted)}
  .dip .value{font-size:.8rem}

  /* Vertical DIP toggles */
  .dip .toggle{
    width:36px; height:68px; border-radius:10px; border:1px solid var(--border);
    background: linear-gradient(180deg, #0b131f, #09101b);
    position:relative; box-shadow: inset 0 2px 4px rgba(0,0,0,.35);
    display:inline-block; cursor:pointer; user-select:none;
  }
  .dip .toggle input{display:none}
  .dip .toggle .knob{
    position:absolute; left:4px; bottom:4px; width:28px; height:26px; border-radius:6px;
    background:#0f2440; border:1px solid #1a3356; box-shadow:0 2px 4px rgba(0,0,0,.35);
    transition:top .15s ease, bottom .15s ease, background .15s ease, border-color .15s ease;
  }
  .dip .toggle input:checked + .knob{ bottom:auto; top:4px; background:#1e90ff; border-color:#1e90ff }
  .dip .toggle .legend{
    position:absolute; left:50%; transform:translateX(-50%); font-size:.62rem; letter-spacing:.2px;
    pointer-events:none; opacity:.45; color:#cdd7e6; text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  .dip .toggle .legend.on{ top:4px } .dip .toggle .legend.off{ bottom:4px }
  .dip .toggle input:checked ~ .legend.on{ opacity:1 } .dip .toggle input:checked ~ .legend.off{ opacity:.25 }
  .dip .toggle input:not(:checked) ~ .legend.off{ opacity:1 } .dip .toggle input:not(:checked) ~ .legend.on{ opacity:.25 }

  .divider{height:1px; background:linear-gradient(90deg, transparent, #1e293b, transparent); margin:12px -6px}
  .badge{font-size:.75rem; padding:3px 8px; border-radius:999px; background:#102136; border:1px solid var(--border)}
  .card .list{display:grid; gap:10px; max-height:460px; overflow:auto; padding-right:2px}
  .item{border:1px solid var(--border); border-radius:12px; padding:10px; background:#0d1627; display:grid; gap:6px}
  .item .row-mini{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .item .title{font-weight:700; letter-spacing:.2px}
  .item .meta{color:var(--muted); font-size:.85rem}
  .item .actions{margin-left:auto; display:flex; gap:8px}
  footer{opacity:.75; font-size:.85rem; padding:18px 8px; text-align:center}
  .success{color:var(--ok)} .warning{color:var(--warn)} .error{color:var(--err)}

  /* Universe color coding */
  tr[data-uni] td{ background: var(--uni-bg); transition: background .2s ease }
  tr[data-uni]{ border-left: 4px solid var(--uni-border) }
  .uni-cell{ display:flex; align-items:center; gap:8px }
  .uni-dot{ width:10px; height:10px; border-radius:999px; background: var(--uni-dot,#888); border:1px solid rgba(255,255,255,.15) }

  /* GDTF Share */
  .note{padding:10px; border:1px solid var(--border); background:#0b1424; border-radius:10px; font-size:.9rem}
  .muted{color:var(--muted)}
  .wrap-scroll{overflow:auto}

  /* Typeahead */
  .typeahead{ position:relative }
  .typeahead input{ width:100% }
  .ta-list{
    position:absolute; left:0; right:0; top:calc(100% + 6px);
    background:#0c1320; border:1px solid var(--border); border-radius:12px;
    box-shadow:var(--shadow); max-height:280px; overflow:auto; z-index:10; display:none;
  }
  .ta-item{
    padding:10px 12px; cursor:pointer; border-bottom:1px solid #0f2036;
    display:flex; gap:8px; align-items:center; justify-content:space-between;
  }
  .ta-item:last-child{ border-bottom:none }
  .ta-item[aria-selected="true"], .ta-item:hover{ background:#0f192c }
  .ta-empty{ padding:10px 12px; color:var(--muted) }
  .ta-tag{ font-size:.75rem; padding:2px 6px; border:1px solid var(--border); border-radius:999px; background:#0e2238 }
  .ta-disabled{ opacity:.6; pointer-events:none }
</style>
</head>
<body>
<header>
  <div class="app">
    <div class="head-wrap">
      <div class="logo" aria-label="LightingApp">
        <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#22d3ee"/><stop offset=".6" stop-color="#60a5fa"/></linearGradient></defs>
          <path d="M28 4c12 0 22 10 22 22 0 6-2 11-6 16l-10 12a4 4 0 0 1-6 0L18 42c-4-5-6-10-6-16C12 14 20 4 28 4Z" stroke="url(#g)" stroke-width="4"/>
          <circle cx="28" cy="26" r="8" fill="url(#g)"/>
        </svg>
        <span>LightingApp – Field Tools</span>
      </div>
      <span class="pill right"><span class="badge">Offline</span> No external deps</span>
    </div>
    <nav class="tabs" role="tablist" aria-label="Tools">
      <button class="tab" data-tab="addr" aria-current="page">Bulk Addressing</button>
      <button class="tab" data-tab="dip">DIP-Switch</button>
      <button class="tab" data-tab="lib">Fixture Library</button>
      <button class="tab" data-tab="gdtf">GDTF Share</button>
      <button class="tab" data-tab="about">About</button>
    </nav>
  </div>
</header>

<main class="app" id="app">

  <!-- BULK ADDRESSING -->
  <section class="card" id="tab-addr" role="tabpanel">
    <h2>Bulk Fixture Addressing</h2>
    <div class="row">
      <div class="field">
        <label for="addr-start">Start Address</label>
        <input id="addr-start" type="number" min="1" max="512" value="1" />
      </div>
      <div class="field">
        <label for="addr-universe">Start Universe</label>
        <input id="addr-universe" type="number" min="1" value="1" />
      </div>
      <div class="field">
        <label for="addr-footprint">Footprint (channels)</label>
        <input id="addr-footprint" type="number" min="1" value="16" />
      </div>
      <div class="field">
        <label for="addr-quantity">Quantity</label>
        <input id="addr-quantity" type="number" min="1" value="8" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="field">
        <label for="addr-gap">Gap Between Fixtures (channels)</label>
        <input id="addr-gap" type="number" min="0" value="0" />
      </div>
      <div class="field">
        <label for="addr-mode">Numbering</label>
        <select id="addr-mode">
          <option value="contiguous" selected>Contiguous across universes</option>
          <option value="reset">Reset to 1 at each new universe</option>
        </select>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <div class="row">
          <button class="btn-primary" id="addr-generate">Generate</button>
          <button class="btn-ghost" id="addr-export">Export CSV</button>
          <button class="btn-ghost" id="addr-copy">Copy Table</button>
        </div>
      </div>
    </div>

    <div class="chips" style="margin:10px 0 6px">
      <span class="chip">Universe is fixed at <b>512 ch</b> (DMX512)</span>
      <span class="chip">Hold <span class="kbd">Alt</span> to edit name/notes inline</span>
    </div>

    <div class="table-wrap" style="margin-top:10px">
      <table id="addr-table">
        <thead><tr>
          <th>#</th><th>Name</th><th>Universe</th><th>Address</th><th>Footprint</th><th>End</th><th>Notes</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- DIP SWITCH -->
  <section class="card" id="tab-dip" role="tabpanel" hidden>
    <h2>DIP-Switch Calculator</h2>
    <div class="row">
      <div class="field">
        <label for="dip-address">DMX Address (1–512)</label>
        <input id="dip-address" type="number" min="1" max="512" value="1" />
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <div class="row">
          <button class="btn-primary" id="dip-apply">Apply</button>
          <button class="btn-ghost" id="dip-clear">Clear</button>
        </div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="toggles" id="dip-toggles" aria-label="DIP switches"></div>

    <div class="chips" style="margin-top:8px">
      <span class="chip">Switch values: 1,2,4,8,16,32,64,128,256</span>
      <span class="chip">Edit switches directly of typ adres</span>
    </div>
  </section>

  <!-- FIXTURE LIBRARY -->
  <section class="card" id="tab-lib" role="tabpanel" hidden>
    <h2>Fixture File Library</h2>
    <div class="row" style="margin-bottom:10px; gap:8px">
      <div class="field" style="flex:2">
        <input id="lib-search" placeholder="Search brand, model, mode…" />
      </div>
      <button class="btn-ghost" id="lib-clear">Clear</button>
      <button class="btn-primary" id="lib-add">Add Fixture</button>
      <button class="btn-ghost" id="lib-import">Import JSON</button>
      <button class="btn-ghost" id="lib-export">Export JSON</button>
    </div>

    <div class="list" id="lib-list"></div>
    <div class="item" id="lib-empty" hidden>No fixtures yet. Add one of import JSON.</div>
  </section>

  <!-- GDTF SHARE -->
  <section class="card" id="tab-gdtf" role="tabpanel" hidden>
    <h2>GDTF Share</h2>
    <div class="row" style="margin-bottom:10px">
      <div class="field">
        <label>Username</label>
        <input id="gdtf-user" placeholder="GDTF Share username" autocomplete="username" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="gdtf-pass" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>
      <div class="field" style="max-width:260px">
        <label>&nbsp;</label>
        <div class="row">
          <button class="btn-primary" id="gdtf-login">Login</button>
          <button class="btn-ghost" id="gdtf-logout">Logout</button>
        </div>
      </div>
    </div>

    <div class="note" id="gdtf-status">Not logged in.</div>

    <div class="row" style="margin:12px 0; align-items:flex-end">
      <button id="gdtf-getlist" class="btn-primary" disabled>Get List</button>

      <!-- Typeahead: Manufacturer -->
      <div class="field" style="min-width:260px; max-width:360px">
        <label for="gdtf-manu-input">Manufacturer</label>
        <div class="typeahead" id="ta-manu">
          <input id="gdtf-manu-input" placeholder="Type manufacturer…" autocomplete="off" disabled />
          <div class="ta-list" id="gdtf-manu-list" role="listbox" aria-label="Manufacturer suggestions"></div>
        </div>
      </div>

      <!-- Typeahead: Fixture (global of binnen manufacturer) -->
      <div class="field" style="min-width:260px; max-width:420px">
        <label for="gdtf-fixture-input">Fixture</label>
        <div class="typeahead ta-disabled" id="ta-fixture">
          <input id="gdtf-fixture-input" placeholder="Type fixture… (kan ook zonder manufacturer)" autocomplete="off" disabled />
          <div class="ta-list" id="gdtf-fixture-list" role="listbox" aria-label="Fixture suggestions"></div>
        </div>
      </div>

      <span class="muted" id="gdtf-count" style="padding:0 4px 6px 4px"></span>
    </div>

    <div class="wrap-scroll table-wrap">
      <table id="gdtf-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="manufacturer" aria-sort="none" title="Sort by Manufacturer">Manufacturer</th>
            <th class="sortable" data-sort="fixture" aria-sort="none" title="Sort by Fixture">Fixture</th>
            <th>Revision</th>
            <th>Modes (name • footprint)</th>
            <th>Rating</th>
            <th>Size</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="hint" style="margin-top:10px">
      Session cookie expires after ~2 hours — log in again if needed.
    </p>
  </section>

  <!-- ABOUT -->
  <section class="card" id="tab-about" role="tabpanel" hidden>
    <h2>About & Shortcuts</h2>
    <p class="hint">Built for mobile/tablet field use. Data is stored locally (localStorage). GDTF Share session uses cookies that expire after ~2 hours.</p>
    <div class="chips" style="margin-top:8px">
      <span class="chip"><strong>Bulk:</strong> <span class="kbd">G</span> generate, <span class="kbd">E</span> export, <span class="kbd">C</span> copy</span>
      <span class="chip"><strong>Nav:</strong> <span class="kbd">1</span> Addressing, <span class="kbd">2</span> DIP, <span class="kbd">3</span> Library, <span class="kbd">4</span> GDTF</span>
    </div>
  </section>

  <footer>© <span id="yr"></span> LightingApp • Designed for on-site workflows</footer>
</main>

<!-- DIALOGS -->
<dialog id="dlg-fixture" style="border:none; border-radius:16px; padding:0; max-width:680px; width:96vw; background:#0f1728; color:var(--text); box-shadow:var(--shadow)">
  <form method="dialog" id="fixture-form" style="display:grid; gap:10px; padding:14px">
    <h3 style="margin:0 0 4px">Fixture</h3>
    <div class="row">
      <div class="field"><label>Brand</label><input name="brand" required /></div>
      <div class="field"><label>Model</label><input name="model" required /></div>
    </div>
    <div class="row">
      <div class="field"><label>Mode Name</label><input name="mode" placeholder="e.g. 16ch Standard" /></div>
      <div class="field"><label>Footprint (ch)</label><input type="number" name="footprint" min="1" value="16" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Profile Links (OF/MA3/gDTF)</label><input name="links" placeholder="comma-separated URLs" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Notes</label><textarea name="notes" rows="3"></textarea></div>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button value="cancel">Cancel</button>
      <button class="btn-primary" value="save">Save</button>
    </div>
    <input type="hidden" name="id" />
  </form>
</dialog>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const UNIVERSE_SIZE = 512;

  // Tabs
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.tab;
      $$('.tab').forEach(b=>b.setAttribute('aria-current', b===btn ? 'page':'false'));
      ['addr','dip','lib','gdtf','about'].forEach(key=>{
        const sec = $('#tab-'+key);
        if(key===id){ sec.hidden=false; } else { sec.hidden=true; }
      });
    });
  });

  // Year
  $('#yr').textContent = new Date().getFullYear();

  // ---------- Bulk Addressing ----------
  const els = {
    start: $('#addr-start'),
    univ: $('#addr-universe'),
    foot: $('#addr-footprint'),
    qty: $('#addr-quantity'),
    gap: $('#addr-gap'),
    mode: $('#addr-mode'),
    tbody: $('#addr-table tbody'),
    gen: $('#addr-generate'),
    exp: $('#addr-export'),
    copy: $('#addr-copy'),
  };

  function calcAddressing({start, universe, footprint, quantity, gap, resetMode}){
    if(footprint > UNIVERSE_SIZE){
      throw new Error('Footprint groter dan 512 (universe size).');
    }
    const rows=[];
    let curA = clamp(start,1,UNIVERSE_SIZE);
    let curU = Math.max(1, universe);
    for(let i=1;i<=quantity;i++){
      if(curA + footprint - 1 > UNIVERSE_SIZE){
        curU += 1;
        if(resetMode==='reset'){
          curA = 1;
        }else{
          curA = (curA + footprint - 1) - UNIVERSE_SIZE + 1;
          if(curA + footprint - 1 > UNIVERSE_SIZE) curA = 1;
        }
      }
      const end = curA + footprint - 1;
      rows.push({ index:i, name:`Fixture ${i}`, universe:curU, address:curA, footprint, end, notes:'' });
      curA = end + 1 + gap;
    }
    return rows;
  }

  function universeColor(u){
    const hue = (u * 47) % 360, sat = 68, light = 28;
    return {
      bg: `hsla(${hue} ${sat}% ${light}% / 0.22)`,
      border: `hsl(${hue} ${sat}% ${light}%)`,
      dot: `hsl(${hue} ${sat}% ${Math.min(light+10,60)}%)`,
    };
  }

  function renderAddressing(rows){
    els.tbody.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      const col = universeColor(r.universe);
      tr.dataset.uni = r.universe;
      tr.style.setProperty('--uni-bg', col.bg);
      tr.style.setProperty('--uni-border', col.border);
      tr.style.setProperty('--uni-dot', col.dot);

      tr.innerHTML = `
        <td class="idx">${r.index}</td>
        <td class="name" contenteditable="plaintext-only" spellcheck="false">${r.name}</td>
        <td class="universe uni-cell" contenteditable="plaintext-only">
          <span class="uni-dot"></span>
          <span>${r.universe}</span>
        </td>
        <td class="address" contenteditable="plaintext-only">${r.address}</td>
        <td>${r.footprint}</td>
        <td>${r.end}</td>
        <td class="notes" contenteditable="plaintext-only">${r.notes}</td>
      `;
      tr.querySelector('.universe').addEventListener('input', e=>{
        e.target.textContent = e.target.textContent.replace(/[^0-9]/g,'');
      });
      tr.querySelector('.address').addEventListener('input', e=>{
        e.target.textContent = e.target.textContent.replace(/[^0-9]/g,'');
      });
      els.tbody.appendChild(tr);
    }
  }

  function getRowsFromTable(){
    return [...els.tbody.querySelectorAll('tr')].map(tr=>{
      const toInt = (sel,def) => {
        const v = parseInt(tr.querySelector(sel)?.textContent.trim()||def,10);
        return Number.isFinite(v)?v:def;
      };
      return {
        index: toInt('.idx',0),
        name: tr.querySelector('.name')?.textContent.trim()||'',
        universe: toInt('.universe',1),
        address: toInt('.address',1),
        footprint: toInt('td:nth-child(5)',1),
        end: toInt('td:nth-child(6)',1),
        notes: tr.querySelector('.notes')?.textContent.trim()||'',
      };
    });
  }

  function exportCSV(){
    const rows = getRowsFromTable();
    const head = ['#','Name','Universe','Address','Footprint','End','Notes'];
    const csv = [head.join(',')].concat(
      rows.map(r=>[r.index,r.name,r.universe,r.address,r.footprint,r.end, `"${(r.notes||'').replace(/"/g,'""')}"`].join(','))
    ).join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'patch.csv';
    document.body.appendChild(a); a.click(); a.remove();
  }

  function copyTable(){
    const rows = getRowsFromTable();
    const txt = rows.map(r=>`${r.index}\t${r.name}\tU${r.universe}\t@${r.address}\t${r.footprint}ch\tend ${r.end}\t${r.notes}`).join('\n');
    navigator.clipboard.writeText(txt).then(()=> toast('Copied table to clipboard','success')).catch(()=> alert('Copy failed'));
  }

  function generate(){
    try{
      const rows = calcAddressing({
        start: +els.start.value || 1,
        universe: +els.univ.value || 1,
        footprint: Math.max(1, +els.foot.value||1),
        quantity: Math.max(1, +els.qty.value||1),
        gap: Math.max(0, +els.gap.value||0),
        resetMode: els.mode.value
      });
      renderAddressing(rows);
      localStorage.setItem('lightingapp.addr.params', JSON.stringify({
        start:+els.start.value, universe:+els.univ.value, footprint:+els.foot.value,
        quantity:+els.qty.value, gap:+els.gap.value, mode:els.mode.value
      }));
    }catch(err){
      toast(err.message || 'Error generating','error');
    }
  }

  els.gen.addEventListener('click', generate);
  els.exp.addEventListener('click', exportCSV);
  els.copy.addEventListener('click', copyTable);
  (function restoreAddr(){
    try{
      const st = JSON.parse(localStorage.getItem('lightingapp.addr.params')||'{}');
      if(st.start) els.start.value = st.start;
      if(st.universe) els.univ.value = st.universe;
      if(st.footprint) els.foot.value = st.footprint;
      if(st.quantity) els.qty.value = st.quantity;
      if(Number.isFinite(st.gap)) els.gap.value = st.gap;
      if(st.mode) els.mode.value = st.mode;
    }catch{}
    generate();
  })();

  // ---------- DIP Switch (base=1) ----------
  const dip = {
    address: $('#dip-address'),
    toggles: $('#dip-toggles'),
    apply: $('#dip-apply'),
    clear: $('#dip-clear'),
  };
  const DIP_VALUES = [1,2,4,8,16,32,64,128,256];

  function renderDIPs(){
    dip.toggles.innerHTML='';
    DIP_VALUES.forEach((v)=>{
      const id = `sw-${v}`;
      const el = document.createElement('div');
      el.className='dip';
      el.innerHTML = `
        <div class="num">${v}</div>
        <label class="toggle" for="${id}">
          <input type="checkbox" id="${id}" data-val="${v}" aria-label="Switch ${v}" />
          <span class="knob" aria-hidden="true"></span>
          <span class="legend on" aria-hidden="true">ON</span>
          <span class="legend off" aria-hidden="true">OFF</span>
        </label>
        <div class="value" id="lbl-${id}">OFF</div>
      `;
      dip.toggles.appendChild(el);
    });
    dip.toggles.addEventListener('change', syncFromSwitches);
  }
  renderDIPs();

  function setSwitchesFor(addr){
    const bitsTarget = Math.max(1, Math.min(512, addr)) - 1;
    DIP_VALUES.forEach(v=>{
      const input = dip.toggles.querySelector(`#sw-${v}`);
      const on = (bitsTarget & v) === v;
      input.checked = on;
      dip.toggles.querySelector(`#lbl-sw-${v}`).textContent = on ? 'ON' : 'OFF';
    });
  }
  function switchesValue(){
    let mask = 0;
    DIP_VALUES.forEach(v=>{
      const input = dip.toggles.querySelector(`#sw-${v}`);
      if(input.checked) mask |= v;
    });
    return (mask & 0x1FF) + 1; // 1..512
  }
  function syncFromAddress(){
    const a = Math.max(1, Math.min(512, +dip.address.value||1));
    setSwitchesFor(a);
  }
  function syncFromSwitches(){
    const addr1 = switchesValue();
    dip.address.value = addr1;
    DIP_VALUES.forEach(v=>{
      const input = dip.toggles.querySelector(`#sw-${v}`);
      dip.toggles.querySelector(`#lbl-sw-${v}`).textContent = input.checked ? 'ON' : 'OFF';
    });
  }
  dip.apply.addEventListener('click', syncFromAddress);
  dip.clear.addEventListener('click', ()=>{
    dip.address.value = 1;
    DIP_VALUES.forEach(v=>{
      const input = dip.toggles.querySelector(`#sw-${v}`);
      input.checked=false;
      dip.toggles.querySelector(`#lbl-sw-${v}`).textContent = 'OFF';
    });
  });
  dip.address.addEventListener('input', syncFromAddress);
  syncFromAddress();

  // ---------- Fixture Library ----------
  const storeKey = 'lightingapp.library.v1';
  const state = { fixtures: [], query: '' };
  const seed = [
    {id:crypto.randomUUID(), brand:'Ayrton', model:'Perseo Profile', mode:'30ch Standard', footprint:30, links:'https://gdtf-share.com/,https://ofl.de/', notes:'IP65 profile'},
    {id:crypto.randomUUID(), brand:'Robe', model:'Spiider', mode:'21ch', footprint:21, links:'https://gdtf-share.com/', notes:'Wash/FX'},
    {id:crypto.randomUUID(), brand:'Chroma-Q', model:'Color Force II 72', mode:'12ch HSI', footprint:12, links:'', notes:''},
  ];
  function loadLibrary(){
    try{
      const raw = localStorage.getItem(storeKey);
      state.fixtures = raw ? JSON.parse(raw) : seed;
      if(!raw) saveLibrary();
    }catch(e){ state.fixtures = []; }
    renderLibrary();
  }
  function saveLibrary(){ localStorage.setItem(storeKey, JSON.stringify(state.fixtures)); }
  function renderLibrary(){
    const list = $('#lib-list');
    const empty = $('#lib-empty');
    list.innerHTML='';
    const q = state.query.trim().toLowerCase();
    const rows = state.fixtures
      .slice()
      .sort((a,b)=> (a.brand+a.model).localeCompare(b.brand+b.model))
      .filter(x=> !q || [x.brand,x.model,x.mode,x.notes].some(v=> (v||'').toLowerCase().includes(q)));
    empty.hidden = rows.length !== 0;
    rows.forEach(x=>{
      const div = document.createElement('div');
      div.className='item';
      const links = (x.links||'').split(',').map(s=>s.trim()).filter(Boolean);
      div.innerHTML = `
        <div class="row-mini">
          <span class="title">${escapeHTML(x.brand)} <span class="meta">•</span> ${escapeHTML(x.model)}</span>
          <span class="badge">${escapeHTML(x.mode||'–')}</span>
          <span class="badge">${x.footprint||'?'} ch</span>
          <div class="actions" style="margin-left:auto; display:flex; gap:8px">
            <button data-act="edit" data-id="${x.id}">Edit</button>
            <button data-act="del" data-id="${x.id}" class="btn-ghost">Delete</button>
          </div>
        </div>
        <div class="meta">${escapeHTML(x.notes||'')}</div>
        ${links.length? `<div class="row-mini">${links.map(u=> `<a href="${u}" target="_blank" rel="noopener" class="badge">${shortURL(u)}</a>`).join(' ')}</div>`:''}
      `;
      list.appendChild(div);
    });
  }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function shortURL(u){ try{ const {host,pathname} = new URL(u); return host + pathname.replace(/\/$/,''); }catch{return u} }
  $('#lib-search').addEventListener('input',(e)=>{ state.query=e.target.value; renderLibrary(); });
  $('#lib-clear').addEventListener('click',()=>{ state.query=''; $('#lib-search').value=''; renderLibrary(); });
  $('#lib-add').addEventListener('click',()=> openFixtureDialog());
  $('#lib-list').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id;
    if(btn.dataset.act==='edit'){ openFixtureDialog(state.fixtures.find(f=>f.id===id)); }
    if(btn.dataset.act==='del'){ if(confirm('Delete this fixture?')){ state.fixtures = state.fixtures.filter(f=>f.id!==id); saveLibrary(); renderLibrary(); } }
  });
  $('#lib-export').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state.fixtures,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'fixtures.json';
    document.body.appendChild(a); a.click(); a.remove();
  });
  $('#lib-import').addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
    inp.onchange = ()=> {
      const f = inp.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const arr = JSON.parse(reader.result);
          if(!Array.isArray(arr)) throw new Error('JSON must be an array');
          const mapped = arr.map(x=> ({
            id: x.id || crypto.randomUUID(),
            brand: x.brand||'',
            model: x.model||'',
            mode: x.mode||'',
            footprint: Number(x.footprint)||null,
            links: x.links||'',
            notes: x.notes||'',
          }));
          state.fixtures = mapped;
          saveLibrary(); renderLibrary(); toast('Imported fixtures','success');
        }catch(err){ toast('Import failed: '+err.message,'error'); }
      };
      reader.readAsText(f);
    };
    inp.click();
  });
  function openFixtureDialog(existing=null){
    const dlg = $('#dlg-fixture');
    const form = $('#fixture-form');
    form.reset();
    form.elements.id.value = existing?.id || '';
    form.elements.brand.value = existing?.brand || '';
    form.elements.model.value = existing?.model || '';
    form.elements.mode.value = existing?.mode || '';
    form.elements.footprint.value = existing?.footprint || 16;
    form.elements.links.value = existing?.links || '';
    form.elements.notes.value = existing?.notes || '';
    dlg.showModal();
    dlg.onclose = null;
    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue === 'save'){
        const data = Object.fromEntries(new FormData(form).entries());
        const rec = {
          id: data.id || crypto.randomUUID(),
          brand: (data.brand||'').trim(),
          model: (data.model||'').trim(),
          mode: (data.mode||'').trim(),
          footprint: Number(data.footprint)||null,
          links: (data.links||'').trim(),
          notes: (data.notes||'').trim(),
        };
        if(!rec.brand || !rec.model){ toast('Brand and model are required','error'); return; }
        const ix = state.fixtures.findIndex(f=>f.id===rec.id);
        if(ix>=0) state.fixtures[ix] = rec; else state.fixtures.push(rec);
        saveLibrary(); renderLibrary(); toast('Saved','success');
      }
    }, {once:true});
  }
  loadLibrary();

  // ---------- GDTF Share (via same-origin Vercel proxy) ----------
  const gdtf = {
    user: $('#gdtf-user'),
    pass: $('#gdtf-pass'),
    login: $('#gdtf-login'),
    logout: $('#gdtf-logout'),
    status: $('#gdtf-status'),
    getList: $('#gdtf-getlist'),

    manuInput: $('#gdtf-manu-input'),
    manuList: $('#gdtf-manu-list'),
    manuWrap: $('#ta-manu'),

    fixInput: $('#gdtf-fixture-input'),
    fixList: $('#gdtf-fixture-list'),
    fixWrap: $('#ta-fixture'),

    count: $('#gdtf-count'),
    tbody: $('#gdtf-table tbody'),

    list: [],
    filtered: [],
    index: { byManu: new Map(), fixturesByManu: new Map(), manus: [], globalFixtures: [] /* [{fixture, manufacturer}] */ },
    sort: { key: null, dir: 'asc' },
    manuSelected: '',   // exact manufacturer
    fixSelected: '',    // exact fixture (within manu if set)
    loggedIn: false
  };

  const GDTF_BASE = '/api/gdtf';

  function setGdtfStatus(msg, kind='info'){
    const colors = {info:'#1f2a3a', ok:'#16a34a', warn:'#f59e0b', err:'#ef4444'};
    gdtf.status.textContent = msg;
    gdtf.status.style.borderColor = colors[kind] || colors.info;
  }

  async function gdtfLogin(){
    try{
      setGdtfStatus('Logging in…');
      const res = await fetch(`${GDTF_BASE}/login`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials: 'include',
        body: JSON.stringify({user: gdtf.user.value, password: gdtf.pass.value})
      });
      if(!res.ok){ setGdtfStatus(`Login failed (${res.status})`,'err'); return; }
      const data = await res.json().catch(()=> ({}));
      if(data?.result){
        gdtf.loggedIn = true;
        gdtf.getList.disabled = false;
        setGdtfStatus(data.notice || 'Logged in. Session cookie active (~2h).','ok');
      }else{
        setGdtfStatus(data?.error || 'Login failed.','err');
      }
    }catch(e){
      setGdtfStatus('Login error.','warn');
    }
  }

  function gdtfLogout(){
    gdtf.loggedIn = false;
    gdtf.getList.disabled = true;
    gdtf.tbody.innerHTML = '';
    gdtf.list = gdtf.filtered = [];
    gdtf.count.textContent = '';
    // reset typeahead UI
    gdtf.manuInput.value = '';
    gdtf.fixInput.value = '';
    gdtf.manuInput.disabled = true;
    gdtf.fixInput.disabled = true;
    gdtf.fixWrap.classList.add('ta-disabled');
    gdtf.manuSelected = '';
    gdtf.fixSelected = '';
    resetSortHeaders();
    setGdtfStatus('Logged out (local).','info');
  }

  function normalizeModes(modes){
    return (Array.isArray(modes)?modes:[]).map(m=>{
      if(m && typeof m==='object'){
        if('name' in m && 'dmxfootprint' in m) return {name:m.name, dmxfootprint:Number(m.dmxfootprint)||null};
        const inner = m['0'] || m[0];
        if(inner && typeof inner==='object') return {name: inner.name, dmxfootprint: Number(inner.dmxfootprint)||null};
      }
      return {name:'', dmxfootprint:null};
    });
  }

  function applySort(rows){
    const { key, dir } = gdtf.sort;
    if(!key) return rows;
    const sign = dir === 'desc' ? -1 : 1;
    const collator = new Intl.Collator(undefined, { sensitivity:'base', numeric:true });
    return rows.slice().sort((a,b)=>{
      const A = (a[key]||'').toString();
      const B = (b[key]||'').toString();
      return sign * collator.compare(A, B);
    });
  }
  function updateSortHeaderUI(){
    $$('#gdtf-table thead th.sortable').forEach(th=> th.setAttribute('aria-sort','none'));
    if(!gdtf.sort.key) return;
    const th = $(`#gdtf-table thead th.sortable[data-sort="${gdtf.sort.key}"]`);
    if(th) th.setAttribute('aria-sort', gdtf.sort.dir === 'asc' ? 'ascending' : 'descending');
  }
  function resetSortHeaders(){
    gdtf.sort.key = null; gdtf.sort.dir = 'asc'; updateSortHeaderUI();
  }

  function renderGdtfTable(rows){
    const sorted = applySort(rows);
    gdtf.tbody.innerHTML = '';
    sorted.forEach(rec=>{
      const tr = document.createElement('tr');
      const modes = normalizeModes(rec.modes);
      const modesHtml = modes.length
        ? modes.map(md=> `<div class="badge" style="display:inline-block; margin:2px 4px 2px 0">${escapeHTML(md.name||'–')} • ${md.dmxfootprint??'?'}ch</div>`).join('')
        : '<span class="muted">–</span>';
      const size = rec.filesize ? (Math.round(rec.filesize/1024)+' KB'):'–';
      const rating = rec.rating!=null ? Number(rec.rating).toFixed(1) : '–';
      tr.innerHTML = `
        <td>${escapeHTML(rec.manufacturer||'')}</td>
        <td>${escapeHTML(rec.fixture||'')}</td>
        <td>${escapeHTML(rec.revision||'')}</td>
        <td>${modesHtml}</td>
        <td>${rating}</td>
        <td>${size}</td>
        <td style="min-width:220px;">
          <div class="row" style="gap:6px">
            <select data-rid="${rec.rid}" class="gdtf-modepick">
              <option value="">Pick mode…</option>
              ${modes.map((md,i)=> `<option value="${i}">${escapeHTML(md.name||'Mode')} • ${md.dmxfootprint??'?'}ch</option>`).join('')}
            </select>
            <button data-act="add" data-rid="${rec.rid}">Add to Library</button>
            <button data-act="dl" data-rid="${rec.rid}">Download</button>
          </div>
          <div class="muted" style="margin-top:6px">RID: ${rec.rid} • UUID: ${escapeHTML(rec.uuid||'')}</div>
        </td>
      `;
      gdtf.tbody.appendChild(tr);
    });
    gdtf.count.textContent = `${sorted.length} result${sorted.length===1?'':'s'}`;
    updateSortHeaderUI();
  }

  function buildIndexes(){
    gdtf.index.byManu = new Map();
    gdtf.index.fixturesByManu = new Map();

    // Build per-manufacturer and global fixture index
    const globalSet = new Set(); // key: fixture|||manufacturer
    for(const rec of gdtf.list){
      const manu = (rec.manufacturer||'').trim();
      const fix = (rec.fixture||'').trim();
      if(!gdtf.index.byManu.has(manu)) gdtf.index.byManu.set(manu, []);
      gdtf.index.byManu.get(manu).push(rec);
      if(!gdtf.index.fixturesByManu.has(manu)) gdtf.index.fixturesByManu.set(manu, new Set());
      if(fix) {
        gdtf.index.fixturesByManu.get(manu).add(fix);
        globalSet.add(`${fix}|||${manu}`);
      }
    }
    gdtf.index.manus = Array.from(gdtf.index.byManu.keys()).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    gdtf.index.globalFixtures = Array.from(globalSet).map(key=>{
      const [fixture, manufacturer] = key.split('|||');
      return { fixture, manufacturer };
    }).sort((a,b)=> (a.fixture+a.manufacturer).localeCompare(b.fixture+b.manufacturer));

    // enable typeahead inputs
    gdtf.manuInput.disabled = false;
    gdtf.fixInput.disabled = false;           // nu ook globaal zoeken mogelijk
    gdtf.fixWrap.classList.remove('ta-disabled');
  }

  function filterRowsBySelections(){
    let rows = gdtf.list;
    const m = gdtf.manuSelected;
    const f = gdtf.fixSelected;
    if(m) rows = rows.filter(r => (r.manufacturer||'') === m);
    if(f) rows = rows.filter(r => (r.fixture||'') === f);
    gdtf.filtered = rows;
    renderGdtfTable(rows);
  }

  async function gdtfGetList(){
    try{
      setGdtfStatus('Fetching revision list…');
      const res = await fetch(`${GDTF_BASE}/getList`, {credentials:'include'});
      if(!res.ok){ const t = await res.text().catch(()=> ''); setGdtfStatus(`Get List failed (${res.status}). ${t||''}`.trim(),'err'); return; }
      const data = await res.json().catch(()=> null);
      if(!data?.result){ setGdtfStatus(data?.error || 'Get List returned error.','err'); return; }
      gdtf.list = Array.isArray(data.list)? data.list : [];
      setGdtfStatus(`Got ${gdtf.list.length} revisions. Timestamp: ${data.timestamp||''}`,'ok');
      buildIndexes();
      gdtf.filtered = gdtf.list.slice();
      resetSortHeaders();
      renderGdtfTable(gdtf.filtered);
    }catch(e){
      setGdtfStatus('Get List error.','warn');
    }
  }

  function addSelectedModeToLibrary(rid){
    const row = gdtf.filtered.find(r=> String(r.rid)===String(rid)) || gdtf.list.find(r=> String(r.rid)===String(rid));
    if(!row){ toast('RID not found','error'); return; }
    const sel = document.querySelector(`select.gdtf-modepick[data-rid="${rid}"]`);
    const ix = Number(sel?.value);
    const modes = normalizeModes(row.modes);
    const md = Number.isInteger(ix) && ix>=0 ? modes[ix] : null;
    const rec = {
      id: crypto.randomUUID(),
      brand: row.manufacturer || '',
      model: row.fixture || '',
      mode: md?.name || (row.revision? `${row.revision}`:''),
      footprint: md?.dmxfootprint || null,
      links: `/api/gdtf/download?rid=${row.rid}`,
      notes: `GDTF RID ${row.rid} • Version ${row.version||'-'}`
    };
    if(!rec.brand || !rec.model){ toast('Missing manufacturer/fixture in record','error'); return; }
    state.fixtures.push(rec);
    saveLibrary(); renderLibrary();
    toast('Added to Fixture Library','success');
  }

  async function downloadGdtf(rid){
    try{
      const url = `/api/gdtf/download?rid=${encodeURIComponent(rid)}`;
      const res = await fetch(url, {credentials:'include'});
      if(!res.ok){
        let msg = `Download failed (${res.status})`;
        try{ const j = await res.json(); if(j?.error) msg += `: ${j.error}`; }catch{}
        toast(msg,'error'); return;
      }
      const blob = await res.blob();
      const row = gdtf.list.find(x=> String(x.rid)===String(rid));
      const fname = `${(row?.manufacturer||'Manuf').replace(/\W+/g,'_')}-${(row?.fixture||'Fixture').replace(/\W+/g,'_')}-${(row?.revision||'rev').replace(/\W+/g,'_')}-RID${rid}.gdtf`;
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fname;
      document.body.appendChild(a); a.click(); a.remove();
      toast('Downloaded GDTF','success');
    }catch(e){
      toast('Download error.','warning');
    }
  }

  // -------- Typeahead component (generic) --------
  function makeTypeahead({wrap, input, listEl, getItems, onChoose, renderItem, placeholder='Type to search…'}){
    let items = [];
    let open = false;
    let activeIndex = -1;
    const MAX = 20;
    input.setAttribute('autocomplete','off');
    input.setAttribute('role','combobox');
    input.setAttribute('aria-expanded','false');
    input.placeholder = placeholder;

    function close(){
      open=false; listEl.style.display='none'; input.setAttribute('aria-expanded','false'); activeIndex=-1;
    }
    function openList(){ open=true; listEl.style.display='block'; input.setAttribute('aria-expanded','true'); }
    function render(){
      listEl.innerHTML='';
      if(items.length===0){
        const div = document.createElement('div'); div.className='ta-empty'; div.textContent='No matches';
        listEl.appendChild(div); return;
      }
      items.forEach((it,i)=>{
        const div = document.createElement('div');
        div.className='ta-item'; div.setAttribute('role','option'); div.dataset.index=i;
        div.innerHTML = renderItem ? renderItem(it) : `<span>${escapeHTML(String(it))}</span>`;
        if(i===activeIndex) div.setAttribute('aria-selected','true');
        div.addEventListener('mouseenter', ()=> { activeIndex=i; updateActive(); });
        div.addEventListener('mousedown', (e)=> e.preventDefault());
        div.addEventListener('click', ()=> choose(i));
        listEl.appendChild(div);
      });
    }
    function updateActive(){
      $$('.ta-item', listEl).forEach((n,ix)=> n.setAttribute('aria-selected', ix===activeIndex ? 'true':'false'));
      const el = listEl.querySelector(`.ta-item[data-index="${activeIndex}"]`);
      if(el){ const r = el.getBoundingClientRect(); const p = listEl.getBoundingClientRect();
        if(r.bottom > p.bottom) listEl.scrollTop += (r.bottom - p.bottom);
        if(r.top < p.top) listEl.scrollTop -= (p.top - r.top);
      }
    }
    function choose(i){
      const val = items[i]; if(!val) return;
      onChoose(val, input, close);
    }
    function doFilter(){
      const q = input.value.trim().toLowerCase();
      const src = getItems();
      // normalize to array of items
      const toStr = (it)=> typeof it==='string' ? it : (it.label || it.value || '');
      const starts = src.filter(s=> toStr(s).toLowerCase().startsWith(q));
      const rest = src.filter(s=> !toStr(s).toLowerCase().startsWith(q) && toStr(s).toLowerCase().includes(q));
      items = (q? starts.concat(rest) : src).slice(0, MAX);
      openList(); activeIndex = items.length ? 0 : -1; render();
    }

    input.addEventListener('input', doFilter);
    input.addEventListener('focus', ()=> { doFilter(); });
    input.addEventListener('keydown', (e)=>{
      if(!open){ if(e.key==='ArrowDown'){ doFilter(); e.preventDefault(); } return; }
      if(e.key==='ArrowDown'){ activeIndex = Math.min(activeIndex+1, items.length-1); updateActive(); e.preventDefault(); }
      else if(e.key==='ArrowUp'){ activeIndex = Math.max(activeIndex-1, 0); updateActive(); e.preventDefault(); }
      else if(e.key==='Enter'){ if(activeIndex>=0){ choose(activeIndex); e.preventDefault(); } }
      else if(e.key==='Escape'){ close(); }
    });
    document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) close(); });

    return { refresh: doFilter, close };
  }

  // Build indexes & typeaheads
  let taManu, taFix;

  function onChooseManufacturer(val){
    gdtf.manuSelected = typeof val === 'string' ? val : val.value;
    gdtf.manuInput.value = gdtf.manuSelected;
    gdtf.fixSelected = '';
    gdtf.fixInput.value = '';
    filterRowsBySelections();
    if(taFix) taFix.refresh();
  }

  function onChooseFixture(val){
    // val can be {value:'fixture', meta:{manufacturer:'...'}} or string when manuSelected exists
    if(typeof val === 'string'){
      gdtf.fixSelected = val;
    }else{
      const fx = val.value;
      const m  = val.meta?.manufacturer || '';
      gdtf.fixSelected = fx;
      gdtf.manuSelected = m || gdtf.manuSelected;
      gdtf.manuInput.value = gdtf.manuSelected;
      gdtf.fixInput.value = fx;
    }
    filterRowsBySelections();
  }

  function setupTypeaheads(){
    taManu = makeTypeahead({
      wrap: gdtf.manuWrap,
      input: gdtf.manuInput,
      listEl: gdtf.manuList,
      getItems: ()=> gdtf.index.manus,
      onChoose: (val, input, close)=>{ onChooseManufacturer(val); close(); },
      placeholder: 'Type manufacturer…'
    });

    taFix = makeTypeahead({
      wrap: gdtf.fixWrap,
      input: gdtf.fixInput,
      listEl: gdtf.fixList,
      getItems: ()=>{
        if(gdtf.manuSelected){
          return Array.from(gdtf.index.fixturesByManu.get(gdtf.manuSelected) || []).sort((a,b)=> a.localeCompare(b));
        }else{
          // global list: objects { value: fixture, meta: { manufacturer }, label: "Fixture — Manufacturer" }
          return gdtf.index.globalFixtures.map(it=> ({
            value: it.fixture,
            meta: { manufacturer: it.manufacturer },
            label: `${it.fixture} — ${it.manufacturer}`
          }));
        }
      },
      renderItem: (it)=> {
        if(typeof it === 'string') return `<span>${escapeHTML(it)}</span>`;
        return `<span>${escapeHTML(it.value)}</span><span class="ta-tag">${escapeHTML(it.meta.manufacturer)}</span>`;
      },
      onChoose: (val, input, close)=>{ onChooseFixture(val); close(); },
      placeholder: 'Type fixture…'
    });

    // Live filtering gedrag bij typen (zonder kiezen)
    gdtf.manuInput.addEventListener('input', ()=>{
      gdtf.manuSelected = '';
      gdtf.fixSelected = '';
      const q = gdtf.manuInput.value.trim().toLowerCase();
      let rows = gdtf.list;
      if(q) rows = rows.filter(r => (r.manufacturer||'').toLowerCase().includes(q));
      gdtf.filtered = rows;
      renderGdtfTable(rows);
      taFix.refresh();
    });

    gdtf.fixInput.addEventListener('input', ()=>{
      gdtf.fixSelected = '';
      const q = gdtf.fixInput.value.trim().toLowerCase();
      let rows = gdtf.list;
      if(gdtf.manuSelected){
        rows = rows.filter(r => (r.manufacturer||'') === gdtf.manuSelected);
      }
      if(q){
        rows = rows.filter(r => (r.fixture||'').toLowerCase().includes(q));
      }
      gdtf.filtered = rows;
      renderGdtfTable(rows);
    });
  }

  // Sort handlers
  $$('#gdtf-table thead th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.sort;
      if(gdtf.sort.key === key){ gdtf.sort.dir = (gdtf.sort.dir === 'asc') ? 'desc' : 'asc'; }
      else{ gdtf.sort.key = key; gdtf.sort.dir = 'asc'; }
      renderGdtfTable(gdtf.filtered);
    });
  });

  // Actions
  $('#gdtf-login').addEventListener('click', gdtfLogin);
  $('#gdtf-logout').addEventListener('click', gdtfLogout);
  $('#gdtf-getlist').addEventListener('click', async ()=>{
    await gdtfGetList();
    setupTypeaheads();
  });

  // Table actions
  $('#gdtf-table').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const rid = btn.dataset.rid;
    if(btn.dataset.act==='add') addSelectedModeToLibrary(rid);
    if(btn.dataset.act==='dl') downloadGdtf(rid);
  });

  // ---------- UX helpers ----------
  function toast(msg,type='info'){
    const colors = {success:'#16a34a', error:'#ef4444', info:'#1f2a3a', warning:'#f59e0b'};
    const fg = {success:'#bbf7d0', error:'#fecaca', info:'#e7eaf0', warning:'#fff7ed'};
    const d = document.createElement('div');
    d.textContent = msg;
    const c = colors[type] || colors.info;
    const fgc = fg[type] || fg.info;
    d.style.cssText = `
      position:fixed; left:50%; transform:translateX(-50%); bottom:20px; z-index:1000;
      background:#0e1a2c; border:1px solid ${c}; color:${fgc};
      padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); font-weight:600; letter-spacing:.2px;
    `;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 1800);
  }

  // Shortcuts
  window.addEventListener('keydown',(e)=>{
    if (['INPUT','SELECT','TEXTAREA'].includes(document.activeElement?.tagName)) return;
    if(e.key==='1') $$('.tab')[0].click();
    if(e.key==='2') $$('.tab')[1].click();
    if(e.key==='3') $$('.tab')[2].click();
    if(e.key==='4') $$('.tab')[3].click();
    if(e.key==='g' || e.key==='G') $('#addr-generate').click();
    if(e.key==='e' || e.key==='E') $('#addr-export').click();
    if(e.key==='c' || e.key==='C') $('#addr-copy').click();
  });

  // Utilities
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function shortURL(u){ try{ const {host,pathname} = new URL(u); return host + pathname.replace(/\/$/,''); }catch{return u} }

})();
</script>
</body>
</html>
